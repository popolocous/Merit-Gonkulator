<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merit Number Check-in</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- Configuration and Global Functions -->
    <script>
        // 1. FORM RESPONSE BASE URL (CORRECT)
        const FORM_RESPONSE_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLScbcQWyLVWLH7oKs81TeswmMhuVF5ezkRanyZXU9jVQ7qGK1g/formResponse"; 

        // 2. MERIT NUMBER ENTRY ID
        const MERIT_NUMBER_ENTRY_ID = "365655658";

        // 3. STUDENT NAME ENTRY ID
        const NAME_ENTRY_ID = "553918421"; 
        
        // 4. STATUS ENTRY ID
        const STATUS_ENTRY_ID = "2105559916";

        // 5. OTHER DETAILS ENTRY ID
        const OTHER_DETAILS_ENTRY_ID = "720030855"; 
        
        // Error check
        if (FORM_RESPONSE_BASE_URL.includes("viewform")) {
            console.error("CONFIGURATION ERROR: FORM_RESPONSE_BASE_URL must use /formResponse, not /viewform.");
        }
        
        let submittedName = ''; // Global to hold the name for the success message
        
        // --- NOTE: Submission now uses the 'fetch' API with URLSearchParams for reliable submission.

    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    
    <!-- The hidden iframe is removed as we are now using fetch API -->
    
    <div id="app" class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-lg transition-all duration-300">
        <div id="loader" class="hidden text-center">
            <svg class="animate-spin mx-auto h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-medium">Submitting data, please wait...</p>
        </div>

        <div id="form-content">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Merit Number Check-in</h1>
            <p class="text-gray-600 mb-6">Merit Number: <span id="asset-display" class="font-bold text-gray-800 bg-indigo-100 px-2 py-0.5 rounded-md">-- Loading --</span></p>

            <!-- Student Name Input -->
            <label for="student-name" class="block text-sm font-medium text-gray-700 mb-2">
                Student Name
            </label>
            <input type="text" id="student-name" placeholder="Enter full name" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm mb-4"
                   required>
                   
            <!-- Status Dropdown -->
            <label for="status-select" class="block text-sm font-medium text-gray-700 mb-2">
                Select Status
            </label>
            <select id="status-select" onchange="toggleOtherDetails()"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm appearance-none bg-white mb-4"
                    required>
                <option value="" disabled selected>-- Choose Status --</option>
                <option value="Awarded">Awarded</option>
                <option value="Redeemed">Redeemed</option>
                <option value="Other">Other (Requires Details)</option>
            </select>

            <!-- Conditional Other Details Input -->
            <div id="other-details-container" class="hidden mb-4 p-4 border border-yellow-300 bg-yellow-50 rounded-lg">
                <label for="other-details" class="block text-sm font-medium text-gray-800 mb-2">
                    Please Specify Details (Required for 'Other')
                </label>
                <input type="text" id="other-details" placeholder="e.g., Error in printing, Lost" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
            </div>

            <button onclick="prepareAndSubmit()" id="submit-button"
                    class="mt-6 w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.103a2.403 2.403 0 00-3.411 0L12 9.584 7.793 5.376a2.403 2.403 0 10-3.411 3.411l5.88 5.88 7.07-7.07a2.403 2.403 0 000-3.411z"></path></svg>
                Check In Merit Number
            </button>
            <p id="error-message" class="text-red-600 mt-4 hidden text-center font-medium"></p>
        </div>
        
        <div id="success-content" class="text-center hidden">
            <svg class="mx-auto w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-2xl font-bold text-green-700 mt-4">Success!</h2>
            <p class="text-gray-600 mt-2">Merit Number data submitted successfully by <span id="submitted-name" class="font-bold"></span>.</p>
            <button onclick="location.reload()" class="mt-6 py-2 px-4 rounded-lg text-white bg-gray-500 hover:bg-gray-600 transition duration-150">Scan Another</button>
        </div>
    </div>

    <script>
        let currentMeritNumber = null;

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function toggleOtherDetails() {
            const statusSelect = document.getElementById('status-select');
            const container = document.getElementById('other-details-container');
            const otherDetailsInput = document.getElementById('other-details');

            if (statusSelect.value === 'Other') {
                container.classList.remove('hidden');
                otherDetailsInput.required = true;
                otherDetailsInput.placeholder = "e.g., Error in printing, Lost";
            } else {
                container.classList.add('hidden');
                otherDetailsInput.required = false;
                otherDetailsInput.value = ''; // Clear the input if not needed
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            currentMeritNumber = getUrlParameter('meritNumber');
            
            if (!currentMeritNumber) {
                document.getElementById('asset-display').textContent = 'ERROR: No Merit Number in URL';
                document.getElementById('error-message').textContent = 'Please scan a valid QR code.';
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('submit-button').disabled = true;
                return;
            }

            document.getElementById('asset-display').textContent = currentMeritNumber;
            document.getElementById('student-name').focus();
        });

        // Updated function to use the fetch API with URLSearchParams, removing the Content-Type header
        // to comply with no-cors limitations, which should allow the submission to pass.
        async function prepareAndSubmit() {
            const nameInput = document.getElementById('student-name');
            const statusSelect = document.getElementById('status-select');
            const otherDetailsInput = document.getElementById('other-details');
            const submitButton = document.getElementById('submit-button');
            
            const studentName = nameInput.value.trim();
            const selectedStatus = statusSelect.value;
            const otherDetails = otherDetailsInput.value.trim();
            
            const errorMessage = document.getElementById('error-message');

            // --- Validation ---
            if (!studentName || !selectedStatus) {
                errorMessage.textContent = 'Please enter your name and select a status.';
                errorMessage.classList.remove('hidden');
                return;
            }

            if (selectedStatus === 'Other' && !otherDetails) {
                errorMessage.textContent = 'Please enter details for the "Other" status.';
                errorMessage.classList.remove('hidden');
                otherDetailsInput.focus();
                return;
            }
            
            // Set global name for success message
            submittedName = studentName;
            
            // Show loader and hide form
            errorMessage.classList.add('hidden');
            document.getElementById('form-content').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            submitButton.disabled = true;

            // --- 1. Create URLSearchParams object (mimics standard form POST data) ---
            const searchParams = new URLSearchParams();
            
            // Add fields to the URLSearchParams object
            searchParams.append(`entry.${MERIT_NUMBER_ENTRY_ID}`, currentMeritNumber); 
            searchParams.append(`entry.${NAME_ENTRY_ID}`, studentName);
            searchParams.append(`entry.${STATUS_ENTRY_ID}`, selectedStatus);

            const detailsToSubmit = selectedStatus === 'Other' ? otherDetails : '';
            searchParams.append(`entry.${OTHER_DETAILS_ENTRY_ID}`, detailsToSubmit);

            // --- 2. Send the request using fetch ---
            try {
                // Use 'no-cors' mode and allow the browser to set the Content-Type header automatically 
                // based on the URLSearchParams string body.
                const response = await fetch(FORM_RESPONSE_BASE_URL, {
                    method: 'POST',
                    // The body is the URL encoded string
                    body: searchParams.toString(),
                    // REMOVED: 'Content-Type': 'application/x-www-form-urlencoded' header
                    mode: 'no-cors' 
                });
                
                // Show success content
                const submittedNameSpan = document.getElementById('submitted-name');
                const successContent = document.getElementById('success-content');
                
                submittedNameSpan.textContent = submittedName;
                document.getElementById('loader').classList.add('hidden');
                successContent.classList.remove('hidden');

            } catch (error) {
                console.error("Submission failed via fetch:", error);
                
                // Revert to form state and show error
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('form-content').classList.remove('hidden');
                submitButton.disabled = false;
                
                errorMessage.textContent = 'An error occurred during submission. Please check your connection or try again.';
                errorMessage.classList.remove('hidden');
            }
        }
    </script>

</body>
</html>
